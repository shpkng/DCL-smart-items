!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("@dcl/npc-scene-utils",["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["@dcl/npc-scene-utils"]={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,i)};function i(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}function o(t,e,i,o){var n,s=arguments.length,r=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(r=(s<3?n(r):s>3?n(e,i,r):n(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r}function n(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],o=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var s=function(){function t(t,e,i){this.lockXZRotation=!1,this.active=!1,r||(r=!0,engine.addSystem(new h)),this.lockXZRotation=t||!1,this.rotSpeed=e||2,i&&(this.active=!0)}return t=o([Component("trackUserFlag")],t)}(),r=!1,a=Camera.instance;var h=function(){function t(){this.followingNPCs=engine.getComponentGroup(s)}return t.prototype.update=function(t){var e,i;try{for(var o=n(this.followingNPCs.entities),r=o.next();!r.done;r=o.next()){var h=r.value,u=h.getComponent(Transform),l=h.getComponent(s);if(l.active){var c=new Vector3(a.position.x,a.position.y,a.position.z).subtract(u.position);u.rotation=Quaternion.Slerp(u.rotation,Quaternion.LookRotation(c),t*l.rotSpeed),l.lockXZRotation&&(u.rotation.x=0,u.rotation.z=0)}}}catch(t){e={error:t}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t}(),u=new UICanvas;u.visible=!0;var l,c,g=new Font(Fonts.SanFrancisco),p=new Font(Fonts.SanFrancisco_Heavy),d=new Texture("https://decentraland.org/images/ui/light-atlas-v3.png"),f=new Texture("https://decentraland.org/images/ui/dark-atlas-v3.png"),m=new Texture("https://decentraland.org/images/ui/dialog-bubbles.png");function b(t,e,i,o){void 0===i&&(i=512),void 0===o&&(o=512),function(t,e,i,o,n){t.uvs=[e.x,e.y,i.x,i.y,o.x,o.y,n.x,n.y,e.x,e.y,i.x,i.y,o.x,o.y,n.x,n.y]}(t,new Vector2(e.sourceLeft/i,(o-e.sourceTop-e.sourceHeight)/o),new Vector2((e.sourceLeft+e.sourceWidth)/i,(o-e.sourceTop-e.sourceHeight)/o),new Vector2((e.sourceLeft+e.sourceWidth)/i,(o-e.sourceTop)/o),new Vector2(e.sourceLeft/i,(o-e.sourceTop)/o))}function T(t,e){t.sourceWidth=e.sourceWidth,t.sourceHeight=e.sourceHeight,t.sourceLeft=e.sourceLeft?e.sourceLeft:0,t.sourceTop=e.sourceTop?e.sourceTop:0}function C(t){var e=-10-4*t;return e>-65?e:-65}(l=t.ButtonStyles||(t.ButtonStyles={})).E="e",l.F="f",l.DARK="dark",l.RED="red",l.ROUNDBLACK="roundblack",l.ROUNDWHITE="roundwhite",l.ROUNDSILVER="roundsilver",l.ROUNDGOLD="roundgold",l.SQUAREBLACK="squareblack",l.SQUAREWHITE="squarewhite",l.SQUARESILVER="squaresilver",l.SQUAREGOLD="squaregold",l.WHITE="white",(c=t.NPCState||(t.NPCState={})).STANDING="standing",c.TALKING="talking",c.FOLLOWPATH="followPath";var y,x={buttons:{buttonE:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:662},buttonF:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:612},white:{sourceWidth:174,sourceHeight:46,sourceLeft:698,sourceTop:662},buttonRed:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:662},buttonDark:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:612},roundBlack:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:458},squareBlack:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:457},roundWhite:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:494},squareWhite:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:493},roundSilver:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:531},squareSilver:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:531},roundGold:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:567},squareGold:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:567}},buttonLabels:{E:{sourceWidth:26,sourceHeight:26,sourceLeft:697,sourceTop:611},F:{sourceWidth:26,sourceHeight:26,sourceLeft:733,sourceTop:611},EBlack:{sourceWidth:26,sourceHeight:26,sourceLeft:766,sourceTop:611},FBlack:{sourceWidth:26,sourceHeight:26,sourceLeft:802,sourceTop:611}},backgrounds:{promptBackground:{sourceWidth:416,sourceHeight:352,sourceLeft:501,sourceTop:12},promptLargeBackground:{sourceWidth:480,sourceHeight:384,sourceLeft:7,sourceTop:12},promptSlantedBackground:{sourceWidth:486,sourceHeight:326,sourceLeft:7,sourceTop:413},NPCDialog:{sourceWidth:766,sourceHeight:248,sourceLeft:22,sourceTop:756}},icons:{closeW:{sourceWidth:32,sourceHeight:32,sourceLeft:942,sourceTop:306},closeD:{sourceWidth:32,sourceHeight:32,sourceLeft:986,sourceTop:306},closeWLarge:{sourceWidth:64,sourceHeight:64,sourceLeft:512,sourceTop:381},closeDLarge:{sourceWidth:64,sourceHeight:64,sourceLeft:583,sourceTop:381},closeWNoBack:{sourceWidth:24,sourceHeight:24,sourceLeft:946,sourceTop:252},closeDNoBack:{sourceWidth:24,sourceHeight:24,sourceLeft:946,sourceTop:214},closeWNoBackLarge:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:214},closeDNoBackLarge:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:260},FDark:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:4},FWhite:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:4},EDark:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:40},EWhite:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:40},Timer:{sourceWidth:24,sourceHeight:32.2,sourceLeft:718,sourceTop:388},TimerLarge:{sourceWidth:48,sourceHeight:68,sourceLeft:662,sourceTop:386},ClickWhite:{sourceWidth:32,sourceHeight:48,sourceLeft:799,sourceTop:389},ClickDark:{sourceWidth:32,sourceHeight:48,sourceLeft:757,sourceTop:389}},checkboxes:{wOff:{sourceWidth:24,sourceHeight:24,sourceLeft:987,sourceTop:76},wOn:{sourceWidth:24,sourceHeight:24,sourceLeft:987,sourceTop:104},dOff:{sourceWidth:24,sourceHeight:24,sourceLeft:958,sourceTop:76},dOn:{sourceWidth:24,sourceHeight:24,sourceLeft:958,sourceTop:104},wLargeOff:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:132},wLargeOn:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:168},dLargeOff:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:132},dLargeOn:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:168}},switches:{roundOff:{sourceWidth:64,sourceHeight:32,sourceLeft:783,sourceTop:454},roundRed:{sourceWidth:64,sourceHeight:32,sourceLeft:853,sourceTop:454},roundGreen:{sourceWidth:64,sourceHeight:32,sourceLeft:923,sourceTop:454},squareOff:{sourceWidth:64,sourceHeight:32,sourceLeft:783,sourceTop:501},squareRed:{sourceWidth:64,sourceHeight:32,sourceLeft:852,sourceTop:501},squareGreen:{sourceWidth:64,sourceHeight:32,sourceLeft:921,sourceTop:501}},bubbles:{short:{sourceWidth:232,sourceHeight:168,sourceLeft:610,sourceTop:834},normal:{sourceWidth:572,sourceHeight:168,sourceLeft:16,sourceTop:834},long:{sourceWidth:994,sourceHeight:306,sourceLeft:12,sourceTop:508},huge:{sourceWidth:994,sourceHeight:478,sourceLeft:12,sourceTop:14}}},v=function(){function t(t,i){var o=this;S.createAndAddToEngine(),this.elapsedTime=0,this.targetTime=t,this.onTimeReachedCallback=i,this.onTargetTimeReached=function(t){o.onTimeReachedCallback(),t.removeComponent(e)}}var e;return e=t,t.prototype.setCallback=function(t){this.onTimeReachedCallback=t},t=e=o([Component("npcTimerDelay")],t)}(),w=engine.getComponentGroup(v),S=function(){function t(){t._instance=this}return t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.update=function(t){var e,i;try{for(var o=n(w.entities),s=o.next();!s.done;s=o.next()){var r=s.value,a=r.getComponent(v);a.elapsedTime+=t,a.elapsedTime>=a.targetTime&&a.onTargetTimeReached(r)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t._instance=null,t}();!function(t){t[t.Confirm=0]="Confirm",t[t.Cancel=1]="Cancel",t[t.Next=2]="Next",t[t.Button3=3]="Button3",t[t.Button4=4]="Button4"}(y||(y={}));var A=.75,E=-262.5,k=262.5,P=37.5,D=192,W=192,O=7.5,B=112.5,I=112.5,_=-48.75,L=-48.75,N=19.5,H=19.5,R=function(){function e(e,i,o,n){var s=this;this.NPCScript=[],this.isDialogOpen=!1,this.isQuestionPanel=!1,this.isFixedScreen=!1,this.activeTextId=0,this.UIOpenTime=0,this.defaultSound=null,this.canvas=u,this.ClickAction=null,this.EButtonAction=null,this.FButtonAction=null,this.defaultPortrait=e||null,this.uiTheme=n||(i?f:d),this.container=new UIContainerRect(u),this.container.adaptWidth=!0,this.container.width="100%",this.container.vAlign="bottom",this.container.positionY=105,this.container.visible=!1,this.panel=new UIImage(this.container,this.uiTheme),T(this.panel,x.backgrounds.NPCDialog),this.panel.width=574.5,this.panel.height=186,this.panel.onClick=new OnClick((function(){s.confirmText(y.Next)})),this.defaultPortraitTexture=new Texture(e?e.path:this.uiTheme.src),this.portrait=new UIImage(this.container,this.defaultPortraitTexture),this.portrait.sourceWidth=e&&e.section?e.section.sourceWidth:256,this.portrait.sourceHeight=e&&e.section?e.section.sourceHeight:256,this.portrait.width=e&&e.width?e.width*A:D,this.portrait.height=e&&e.height?e.height*A:D,this.portrait.positionX=e&&e.offsetX?e.offsetX*A+E:E,this.portrait.positionY=e&&e.offsetY?e.offsetY*A+0:0,this.portrait.onClick=new OnClick((function(){s.confirmText(y.Next)})),this.image=new UIImage(this.container,new Texture(this.uiTheme.src)),this.image.sourceWidth=256,this.image.sourceHeight=256,this.image.sourceTop=0,this.image.sourceLeft=0,this.image.width=W,this.image.height=W,this.image.positionX=k,this.image.positionY=P,this.image.onClick=new OnClick((function(){s.confirmText(y.Next)})),this.text=new UIText(this.container),this.text.adaptWidth=!1,this.text.textWrapping=!0,this.text.width=345,this.text.positionX=30,this.text.hAlign="center",this.text.vAlign="center",this.text.font=p,this.text.fontSize=18,this.text.hTextAlign="left",this.text.vTextAlign="center",this.text.positionY=O,this.text.fontWeight="normal",this.text.color=i?Color4.White():Color4.Black(),this.text.isPointerBlocker=!1,this.soundEnt=new Entity,this.soundEnt.addComponent(new Transform),engine.addEntity(this.soundEnt),this.soundEnt.setParent(Attachable.AVATAR),o&&(this.soundEnt.addComponent(new AudioSource(new AudioClip(o))),this.soundEnt.getComponent(AudioSource).volume=.5,this.defaultSound=o),this.button1=new Y(this.container,this.uiTheme,"yes",B,_,(function(){s.confirmText(y.Confirm)}),!1,t.ButtonStyles.E),this.button1.hide(),this.button2=new Y(this.container,this.uiTheme,"no",-60,L,(function(){s.confirmText(y.Cancel)}),!1,t.ButtonStyles.F),this.button2.hide(),this.button3=new Y(this.container,this.uiTheme,"maybe",-60,-60,(function(){s.confirmText(y.Button3)}),!1,t.ButtonStyles.DARK),this.button3.hide(),this.button4=new Y(this.container,this.uiTheme,"maybe",I,-60,(function(){s.confirmText(y.Button4)}),!1,t.ButtonStyles.DARK),this.button4.hide(),this.skipButton=new Y(this.container,this.uiTheme,"Skip",-225,-75,(function(){s.skipDialogs()}),!1,f?t.ButtonStyles.WHITE:t.ButtonStyles.F),this.skipButton.image.width=60,this.skipButton.image.height=22.5,this.skipButton.label.hTextAlign="left",this.skipButton.label.fontSize=9,this.skipButton.label.positionX=30,this.skipButton.label.font=p,this.skipButton.icon.height=15,this.skipButton.icon.width=15,this.skipButton.icon.positionX=-15,this.skipButton.hide(),this.leftClickIcon=new UIImage(this.container,this.uiTheme),this.leftClickIcon.width=24,this.leftClickIcon.height=36,this.leftClickIcon.positionX=255,this.leftClickIcon.positionY=-60,this.leftClickIcon.visible=!1,T(this.leftClickIcon,i?x.icons.ClickDark:x.icons.ClickWhite),U.createAndAddToEngine()}return e.prototype.openDialogWindow=function(t,e){var i=this;this.UIOpenTime=+Date.now(),this.NPCScript=t,this.activeTextId=e?"number"==typeof e?e:F(t,e):0;var o=t[this.activeTextId]?t[this.activeTextId]:{text:""};if(o.audio?(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(o.audio))),this.soundEnt.getComponent(AudioSource).volume=.5,this.soundEnt.getComponent(AudioSource).playOnce()):this.defaultSound&&(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(this.defaultSound))),this.soundEnt.getComponent(AudioSource).playOnce()),o.portrait?(this.portrait.source=new Texture(o.portrait.path),this.portrait.positionX=o.portrait.offsetX?o.portrait.offsetX*A+E:E,this.portrait.positionY=o.portrait.offsetY?o.portrait.offsetY*A+0:0,this.portrait.width=o.portrait.width?o.portrait.width*A:D,this.portrait.height=o.portrait.height?o.portrait.height*A:D,o.portrait.section&&T(this.portrait,o.portrait.section),this.portrait.visible=!0):this.defaultPortrait?(this.portrait.source=this.defaultPortraitTexture,this.portrait.positionX=this.defaultPortrait&&this.defaultPortrait.offsetX?this.defaultPortrait.offsetX*A+E:E,this.portrait.positionY=this.defaultPortrait&&this.defaultPortrait.offsetY?this.defaultPortrait.offsetY*A+0:0,this.portrait.width=this.defaultPortrait&&this.defaultPortrait.width?this.defaultPortrait.width*A:D,this.portrait.height=this.defaultPortrait&&this.defaultPortrait.height?this.defaultPortrait.height*A:D,this.defaultPortrait.section&&T(this.portrait,this.defaultPortrait.section),this.portrait.visible=!0):(log("No portrait"),this.portrait.visible=!1),o.image){var n=o.image;log("setting image to ",n.path),this.image.source=new Texture(n.path),this.image.positionX=n.offsetX?n.offsetX*A+k:k,this.image.positionY=n.offsetY?n.offsetY*A+P:P,this.image.width=n.width?n.width*A:W,this.portrait.height=n.height?n.height*A:W,n.section&&T(this.image,n.section),this.image.visible=!0}else this.image.visible=!1;this.text.fontSize=o.fontSize?o.fontSize*A:18,this.text.positionY=o.offsetY?o.offsetY*A+O:O,this.text.positionX=o.offsetX?o.offsetX*A:0,this.text.visible=!0,this.container.visible=!0,U._instance.newText(this,o.text,this.activeTextId,o.typeSpeed?o.typeSpeed:void 0),this.ClickAction||(this.ClickAction=Input.instance.subscribe("BUTTON_DOWN",ActionButton.POINTER,!1,(function(t){!i.isDialogOpen||+Date.now()-i.UIOpenTime<100||(U._instance.done?i.isQuestionPanel||i.isFixedScreen||i.confirmText(y.Next):U._instance.rush())})),this.EButtonAction=Input.instance.subscribe("BUTTON_DOWN",ActionButton.PRIMARY,!1,(function(t){i.isDialogOpen&&i.isQuestionPanel&&U._instance.done&&+Date.now()-i.UIOpenTime>100&&i.confirmText(y.Confirm)})),this.FButtonAction=Input.instance.subscribe("BUTTON_DOWN",ActionButton.SECONDARY,!1,(function(t){i.isDialogOpen&&i.isQuestionPanel&&U._instance.done&&+Date.now()-i.UIOpenTime>100?i.confirmText(y.Cancel):i.isDialogOpen&&o.skipable&&+Date.now()-i.UIOpenTime>100&&i.skipDialogs()}))),this.layoutDialogWindow(this.activeTextId),this.isDialogOpen=!0},e.prototype.confirmText=function(t){var e=this.NPCScript[this.activeTextId];if(t==y.Next&&!e.isQuestion){if(e.triggeredByNext&&e.triggeredByNext(),e.isEndOfDialog)return void this.closeDialogWindow();this.activeTextId++}t==y.Confirm&&e.buttons&&e.buttons.length>=1&&("number"==typeof e.buttons[0].goToDialog?this.activeTextId=e.buttons[0].goToDialog:this.activeTextId=F(this.NPCScript,e.buttons[0].goToDialog),e.buttons[0].triggeredActions&&e.buttons[0].triggeredActions()),t==y.Cancel&&e.buttons&&e.buttons.length>=2&&("number"==typeof e.buttons[1].goToDialog?this.activeTextId=e.buttons[1].goToDialog:this.activeTextId=F(this.NPCScript,e.buttons[1].goToDialog),e.buttons[1].triggeredActions&&e.buttons[1].triggeredActions()),t==y.Button3&&e.buttons&&e.buttons.length>=3&&("number"==typeof e.buttons[2].goToDialog?this.activeTextId=e.buttons[2].goToDialog:this.activeTextId=F(this.NPCScript,e.buttons[2].goToDialog),e.buttons[2].triggeredActions&&e.buttons[2].triggeredActions()),t==y.Button4&&e.buttons&&e.buttons.length>=4&&("number"==typeof e.buttons[3].goToDialog?this.activeTextId=e.buttons[3].goToDialog:this.activeTextId=F(this.NPCScript,e.buttons[3].goToDialog),e.buttons[3].triggeredActions&&e.buttons[3].triggeredActions()),e=this.NPCScript[this.activeTextId],U._instance.newText(this,e.text,this.activeTextId,e.typeSpeed?e.typeSpeed:void 0)},e.prototype.layoutDialogWindow=function(t){var e=this,i=this.NPCScript[t]?this.NPCScript[t]:{text:""},o=i.offsetY?i.offsetY*A+O:O;if(i.buttons&&i.buttons.length>=3?o+=37.5:i.buttons&&i.buttons.length>=1&&(o+=18),this.text.fontSize=i.fontSize?i.fontSize*A:18,this.text.positionY=o,i.audio?(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(i.audio))),this.soundEnt.getComponent(AudioSource).volume=.5,this.soundEnt.getComponent(AudioSource).playOnce()):this.defaultSound&&(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(this.defaultSound))),this.soundEnt.getComponent(AudioSource).playOnce()),i.portrait?(this.portrait.source=new Texture(i.portrait.path),this.portrait.positionX=i.portrait.offsetX?i.portrait.offsetX*A+E:E,this.portrait.positionY=i.portrait.offsetY?i.portrait.offsetY*A+0:0,this.portrait.width=i.portrait.width?i.portrait.width*A:D,this.portrait.height=i.portrait.height?i.portrait.height*A:D,i.portrait.section&&T(this.portrait,i.portrait.section),this.portrait.visible=!0):this.defaultPortrait?(this.portrait.source=new Texture(this.defaultPortrait.path),this.portrait.positionX=this.defaultPortrait&&this.defaultPortrait.offsetX?this.defaultPortrait.offsetX*A+E:E,this.portrait.positionY=this.defaultPortrait&&this.defaultPortrait.offsetY?this.defaultPortrait.offsetY*A+0:0,this.portrait.width=this.defaultPortrait&&this.defaultPortrait.width?this.defaultPortrait.width*A:D,this.portrait.height=this.defaultPortrait&&this.defaultPortrait.height?this.defaultPortrait.height*A:D,this.defaultPortrait.section&&T(this.portrait,this.defaultPortrait.section),this.portrait.visible=!0):(log("No portrait"),this.portrait.visible=!1),this.image.visible=!1,i.image){var n=i.image;log("setting image to ",n.path),this.image.source=new Texture(n.path),this.image.positionX=n.offsetX?n.offsetX*A+k:k,this.image.positionY=n.offsetY?n.offsetY*A+P:P,this.image.width=i.image.width?i.image.width*A:W,this.image.height=i.image.height?i.image.height*A:W,n.section&&T(this.image,n.section),this.image.visible=!0}else this.image.visible=!1;this.isQuestionPanel=!!i.isQuestion&&i.isQuestion,this.isFixedScreen=!!i.isFixedScreen&&i.isFixedScreen,this.button1.hide(),this.button2.hide(),this.button3.hide(),this.button4.hide(),this.leftClickIcon.visible=!1,i.isQuestion?(this.skipButton.hide(),i.buttons&&i.buttons.length>=1&&this.button1.update(i.buttons[0].label,i.buttons[0].offsetX?i.buttons[0].offsetX*A+B:B,i.buttons.length>=3?i.buttons[0].offsetY?i.buttons[0].offsetY*A-15:-15:i.buttons[0].offsetY?i.buttons[0].offsetY*A+_:_),i.buttons&&i.buttons.length>=2&&this.button2.update(i.buttons[1].label,i.buttons[1].offsetX*A?i.buttons[1].offsetX*A-60:-60,i.buttons.length>=3?i.buttons[1].offsetY*A?i.buttons[1].offsetY*A-15:-15:i.buttons[1].offsetY*A?i.buttons[1].offsetY*A+L:L),i.buttons&&i.buttons.length>=3&&this.button3.update(i.buttons[2].label,i.buttons[2].offsetX*A?i.buttons[2].offsetX*A-60:-60,i.buttons[2].offsetY*A?i.buttons[2].offsetY*A-60:-60),i.buttons&&i.buttons.length>=4&&this.button4.update(i.buttons[3].label,i.buttons[3].offsetX*A?i.buttons[3].offsetX*A+I:I,i.buttons[3].offsetY*A?i.buttons[3].offsetY*A-60:-60),X.addComponentOrReplace(new v(.7,(function(){i.buttons&&i.buttons.length>=1&&e.button1.show(),i.buttons&&i.buttons.length>=2&&e.button2.show(),i.buttons&&i.buttons.length>=3&&e.button3.show(),i.buttons&&i.buttons.length>=4&&e.button4.show()})))):this.isFixedScreen||(this.leftClickIcon.visible=!0,i.skipable?this.skipButton.show():this.skipButton.hide())},e.prototype.closeDialogWindow=function(){this.isDialogOpen&&(this.isDialogOpen=!1,this.portrait.visible=!1,this.text.value="",this.text.visible=!1,this.button1.hide(),this.button2.hide(),this.button3.hide(),this.button4.hide(),this.skipButton.hide(),this.leftClickIcon.visible=!1,this.container.visible=!1)},e.prototype.skipDialogs=function(){if(this.isDialogOpen&&!(+Date.now()-this.UIOpenTime<100)){for(;this.NPCScript[this.activeTextId]&&this.NPCScript[this.activeTextId].skipable&&!this.NPCScript[this.activeTextId].isQuestion;){if(this.NPCScript[this.activeTextId].triggeredByNext&&this.NPCScript[this.activeTextId].triggeredByNext(),this.NPCScript[this.activeTextId].skipable&&this.NPCScript[this.activeTextId].isEndOfDialog)return void this.closeDialogWindow();this.activeTextId+=1}this.confirmText(y.Next)}},e}(),U=function(){function t(){this.timer=0,this.speed=45,this.visibleChars=0,this.fullText="",this.UIText=null,this.done=!0,t._instance=this}return t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.update=function(t){if(!this.done&&(this.timer+=t,this.timer>=2/this.speed)){var e=Math.floor(this.timer/(1/this.speed));this.timer=0,this.visibleChars+=e,this.closeTag(e),this.visibleChars>=this.fullText.length&&(this.done=!0,this.visibleChars=this.fullText.length),this.UIText&&(this.UIText.value=this.fullText.substr(0,this.visibleChars))}},t.prototype.newText=function(t,e,i,o){this.timer=0,this.done=!1,this.UIText=t.text,this.fullText=e,this.visibleChars=0,o&&o<=0?this.rush():this.speed=o||45,t.layoutDialogWindow(i)},t.prototype.rush=function(){this.done=!0,this.timer=0,this.visibleChars=this.fullText.length,this.UIText&&(this.UIText.value=this.fullText)},t.prototype.closeTag=function(t){if(0!=this.visibleChars&&0!=t){for(var e=!1,i=!1,o=this.visibleChars-t;o<this.visibleChars;o++)e?">"==this.fullText.substr(o,1)&&(i=!0):"<"==this.fullText.substr(o,1)&&(e=!0);if(e&&!i)for(;this.visibleChars<this.fullText.length&&">"!=this.fullText.substr(this.visibleChars-1,1);)this.visibleChars+=1}},t._instance=null,t}(),Y=function(e){function o(i,o,n,s,r,a,h,u){var l=e.call(this)||this;if(l.icon=null,l.image=new UIImage(i,o),l.image.positionX=s,l.image.positionY=r,l.image.width=130.5,l.image.height=34.5,l.label=new UIText(l.image),l.style=u||null,l.onClick=a,l.style)switch(l.style){case t.ButtonStyles.E:T(l.image,x.buttons.buttonE),l.label.positionX=18.75,l.icon=new UIImage(l.image,1==h?f:d),l.icon.width=N,l.icon.height=H,l.icon.hAlign="center",l.icon.vAlign="center",l.icon.isPointerBlocker=!1,T(l.icon,x.buttonLabels.E),l.icon.positionX=C(n.length);break;case t.ButtonStyles.F:T(l.image,x.buttons.buttonF),l.label.positionX=18.75,l.icon=new UIImage(l.image,1==h?f:d),l.icon.width=N,l.icon.height=H,l.icon.hAlign="center",l.icon.vAlign="center",l.icon.isPointerBlocker=!1,T(l.icon,x.buttonLabels.F),l.icon.positionX=C(n.length);break;case t.ButtonStyles.WHITE:T(l.image,x.buttons.white),l.label.positionX=18.75,l.icon=new UIImage(l.image,1==h?f:d),l.icon.width=N,l.icon.height=H,l.icon.hAlign="center",l.icon.vAlign="center",l.icon.isPointerBlocker=!1,T(l.icon,x.buttonLabels.FBlack),l.icon.positionX=C(n.length);break;case t.ButtonStyles.RED:T(l.image,x.buttons.buttonRed);break;case t.ButtonStyles.DARK:T(l.image,x.buttons.buttonDark);break;case t.ButtonStyles.ROUNDBLACK:T(l.image,x.buttons.roundBlack);break;case t.ButtonStyles.ROUNDWHITE:T(l.image,x.buttons.roundWhite);break;case t.ButtonStyles.ROUNDSILVER:T(l.image,x.buttons.roundSilver);break;case t.ButtonStyles.ROUNDGOLD:T(l.image,x.buttons.roundGold);break;case t.ButtonStyles.SQUAREBLACK:T(l.image,x.buttons.squareBlack);break;case t.ButtonStyles.SQUAREWHITE:T(l.image,x.buttons.squareWhite);break;case t.ButtonStyles.SQUARESILVER:T(l.image,x.buttons.squareSilver);break;case t.ButtonStyles.SQUAREGOLD:T(l.image,x.buttons.squareGold)}else T(l.image,x.buttons.roundSilver);return l.label.value=n,l.label.hTextAlign="center",l.label.vTextAlign="center",l.label.fontSize=15,l.label.font=g,l.label.color=u==t.ButtonStyles.ROUNDWHITE||u==t.ButtonStyles.SQUAREWHITE||u==t.ButtonStyles.WHITE?Color4.Black():Color4.White(),l.label.isPointerBlocker=!1,l.image.onClick=new OnClick((function(){l.onClick()})),u==t.ButtonStyles.E?Input.instance.subscribe("BUTTON_DOWN",ActionButton.PRIMARY,!1,(function(t){l.image.visible&&l.onClick()})):u==t.ButtonStyles.F&&Input.instance.subscribe("BUTTON_DOWN",ActionButton.SECONDARY,!1,(function(t){l.image.visible&&l.onClick()})),l}return i(o,e),o.prototype.hide=function(){this.image.visible=!1},o.prototype.show=function(){this.image.visible=!0},o.prototype.grayOut=function(){this.label.color=Color4.Gray(),this.image.isPointerBlocker=!1},o.prototype.enable=function(){this.label.color=Color4.White(),this.image.isPointerBlocker=!0},o.prototype.update=function(e,i,o){this.label.value=e,this.image.positionX=i,this.image.positionY=o,!this.icon||this.style!=t.ButtonStyles.E&&this.style!=t.ButtonStyles.F||(this.icon.positionX=C(e.length))},o}(Entity),X=new Entity;function F(t,e){for(var i=0;i<t.length;i++)if(t[i].name&&t[i].name==e)return i;return 0}engine.addEntity(X);var z=function(){function t(){this._triggers={},t._instance=this,this._cameraTriggerWrapper=new V(new j(new Vector3(.5,1.8,.5),new Vector3(0,.91,0))),this._componentGroup=engine.getComponentGroup(Q)}return Object.defineProperty(t,"instance",{get:function(){return this.createAndAddToEngine()},enumerable:!1,configurable:!0}),t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.setCameraTriggerShape=function(t){this._cameraTriggerWrapper.setShape(t)},t.prototype.update=function(){var e=this,i=this._componentGroup.entities;for(var o in i.forEach((function(t){e.shouldWrapTriggerEntity(t)&&e.wrapTriggerEntity(t)})),this._triggers)if(this._triggers.hasOwnProperty(o)){var n=this._triggers[o];n.isDebugging()&&n.updateDebugEntity(),n.isInEngine()?null!=n.trigger&&n.trigger.enabled?(n.wasEnabled||n.isDebugging()&&n.addDebugEntity(),n.wasEnabled=!0,(n.trigger.onCameraEnter||n.trigger.onCameraExit)&&this.checkCollisionAgainstCamera(n),(n.trigger.onTriggerEnter||n.trigger.onTriggerExit)&&this.checkCollisionAgainstOtherTriggers(n)):n.wasEnabled&&(n.wasEnabled=!1,n.isDebugging()&&n.removeDebugEntity(),t.removeTriggerFromSystem(n)):(n.isDebugging()&&n.removeDebugEntity(),t.removeTriggerFromSystem(n),delete this._triggers[o])}},t.prototype.shouldWrapTriggerEntity=function(t){return null==this._triggers[t.uuid]||null==this._triggers[t.uuid]},t.prototype.wrapTriggerEntity=function(t){this._triggers[t.uuid]=new G(t)},t.removeTriggerFromSystem=function(e){for(var i,o=e.getActiveCollisions(),n=0;n<o.length;n++){!(o[n]===(null===(i=t._instance)||void 0===i?void 0:i._cameraTriggerWrapper)||null==o[n].trigger)&&o[n].trigger.onTriggerExit&&e.entity&&o[n].trigger.onTriggerExit(e.entity),o[n].disengageActiveCollision(e),e.disengageActiveCollision(o[n])}},t.disengageCollision=function(t,e){t.disengageActiveCollision(e),e.disengageActiveCollision(t),t.trigger.onTriggerExit&&e.entity&&t.trigger.onTriggerExit(e.entity),e.trigger.onTriggerExit&&t.entity&&e.trigger.onTriggerExit(t.entity)},t.engageCollision=function(t,e){t.engageCollision(e),e.engageCollision(t),t.trigger.onTriggerEnter&&e.entity&&t.trigger.onTriggerEnter(e.entity),e.trigger.onTriggerEnter&&t.entity&&e.trigger.onTriggerEnter(t.entity)},t.prototype.checkCollisionAgainstCamera=function(e){var i=e.hasActiveCollision(this._cameraTriggerWrapper),o=t.areColliding(e,this._cameraTriggerWrapper);i&&!o?(e.disengageActiveCollision(this._cameraTriggerWrapper),e.trigger.onCameraExit&&e.trigger.onCameraExit()):!i&&o&&(e.engageCollision(this._cameraTriggerWrapper),e.trigger.onCameraEnter&&e.trigger.onCameraEnter())},t.prototype.checkCollisionAgainstOtherTriggers=function(e){for(var i in this._triggers)if(this._triggers.hasOwnProperty(i)&&i!=e.uuid&&this._triggers[i].trigger.enabled&&t.canTriggersCollide(e,this._triggers[i])){var o=e.hasActiveCollision(this._triggers[i]),n=t.areColliding(e,this._triggers[i]);o&&!n?t.disengageCollision(e,this._triggers[i]):!o&&n&&t.engageCollision(e,this._triggers[i])}},t.canTriggersCollide=function(t,e){return 0==t.trigger.triggeredByLayer||0!=(e.trigger.layer&t.trigger.triggeredByLayer)},t.areColliding=function(e,i){return e.getShape()instanceof j&&i.getShape()instanceof j?t.areCollidingAABB(e.getGlobalPosition(),e.getShape(),i.getGlobalPosition(),i.getShape()):e.getShape()instanceof q&&i.getShape()instanceof q?t.areCollidingSphere(e.getGlobalPosition(),e.getShape(),i.getGlobalPosition(),i.getShape()):e.getShape()instanceof j&&i.getShape()instanceof q?t.areCollidingAABBSphere(e.getGlobalPosition(),e.getShape(),i.getGlobalPosition(),i.getShape()):e.getShape()instanceof q&&i.getShape()instanceof j&&t.areCollidingAABBSphere(i.getGlobalPosition(),i.getShape(),e.getGlobalPosition(),e.getShape())},t.areCollidingAABB=function(e,i,o,n){var s=t.getBoxShapeValues(e,i),r=t.getBoxShapeValues(o,n);return s.min.x<=r.max.x&&s.max.x>=r.min.x&&s.min.y<=r.max.y&&s.max.y>=r.min.y&&s.min.z<=r.max.z&&s.max.z>=r.min.z},t.areCollidingSphere=function(t,e,i,o){return Vector3.DistanceSquared(t.add(e.position),i.add(o.position))<e.radius*e.radius+o.radius*o.radius},t.areCollidingAABBSphere=function(e,i,o,n){var s=t.getBoxShapeValues(e,i),r=o.add(n.position),a=n.radius,h=0;return r.x<s.min.x&&(h+=(s.min.x-r.x)*(s.min.x-r.x)),r.x>s.max.x&&(h+=(r.x-s.max.x)*(r.x-s.max.x)),r.y<s.min.y&&(h+=(s.min.y-r.y)*(s.min.y-r.y)),r.y>s.max.y&&(h+=(r.y-s.max.y)*(r.y-s.max.y)),r.z<s.min.z&&(h+=(s.min.z-r.z)*(s.min.z-r.z)),r.z>s.max.z&&(h+=(r.z-s.max.z)*(r.z-s.max.z)),h<a*a},t.getBoxShapeValues=function(t,e){var i=t.add(e.position);return{center:i,min:i.subtract(e.size.scale(.5)),max:i.add(e.size.scale(.5))}},t._instance=null,t}(),G=function(){function t(t){this.wasEnabled=!0,this._uuid="",this._collidingWith={},this._isDebug=!1,this._debugEntity=null,this._entity=t,t&&(this._trigger=t.getComponent(Q),this._uuid=t.uuid,this._isDebug=this._trigger.debugEnabled,this._isDebug&&this.addDebugEntity())}return Object.defineProperty(t.prototype,"entity",{get:function(){return this._entity},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"trigger",{get:function(){return this._trigger},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uuid",{get:function(){return this._uuid},enumerable:!1,configurable:!0}),t.prototype.getGlobalPosition=function(){return this._entity?t.getEntityWorldPosition(this._entity):Vector3.Zero()},t.prototype.getShape=function(){return this._trigger.shape},t.prototype.isInEngine=function(){return null!=this._entity&&this._entity.isAddedToEngine()},t.prototype.getActiveCollisions=function(){var t=[];for(var e in this._collidingWith)this._collidingWith.hasOwnProperty(e)&&t.push(this._collidingWith[e]);return t},t.prototype.hasActiveCollision=function(t){return null!=this._collidingWith[t.uuid]&&null!=this._collidingWith[t.uuid]},t.prototype.disengageActiveCollision=function(t){delete this._collidingWith[t.uuid]},t.prototype.engageCollision=function(t){this._collidingWith[t.uuid]=t},t.prototype.isDebugging=function(){return this._isDebug},t.prototype.addDebugEntity=function(){if(t._debugMaterial||(t._debugMaterial=new Material,t._debugMaterial.alphaTest=.5),null==this._debugEntity){this._debugEntity=new Entity;var e=new Transform;if(this._debugEntity.addComponent(e),this._debugEntity.addComponent(t._debugMaterial),this.getShape()instanceof j)(i=new BoxShape).withCollisions=!1,this._debugEntity.addComponent(i),e.scale=this.getShape().size;if(this.getShape()instanceof q){var i;(i=new SphereShape).withCollisions=!1,this._debugEntity.addComponent(i);var o=this.getShape().radius;e.scale=new Vector3(o,o,o)}}engine.addEntity(this._debugEntity)},t.prototype.removeDebugEntity=function(){null!=this._debugEntity&&engine.removeEntity(this._debugEntity)},t.prototype.updateDebugEntity=function(){this._debugEntity&&(this._debugEntity.getComponent(Transform).position=this.getGlobalPosition().add(this.getShape().position))},t.getEntityWorldPosition=function(t){var e=t.hasComponent(Transform)?t.getComponent(Transform).position.clone():Vector3.Zero(),i=t.getParent();if(null!=i){var o=i.hasComponent(Transform)?i.getComponent(Transform).rotation:Quaternion.Identity;return this.getEntityWorldPosition(i).add(e.rotate(o))}return e},t._debugMaterial=null,t}(),V=function(t){function e(e){var i=t.call(this)||this;return i._shape=e,i._uuid="cameraTrigger",i}return i(e,t),e.prototype.getGlobalPosition=function(){return Camera.instance.position},e.prototype.getShape=function(){return this._shape},e.prototype.setShape=function(t){this._shape=t},e.prototype.isInEngine=function(){return!1},e.prototype.hasActiveCollision=function(t){return!1},e.prototype.disengageActiveCollision=function(t){},e.prototype.engageCollision=function(t){},e.prototype.isDebugging=function(){return!1},e}(G),Q=function(){function t(t,e){this.enabled=!0,this.layer=0,this.triggeredByLayer=0,z.createAndAddToEngine(),this.shape=t,this.layer=e&&e.layer?e.layer:0,this.triggeredByLayer=e&&e.triggeredByLayer?e.triggeredByLayer:0,this.onTriggerEnter=e&&e.onTriggerEnter?e.onTriggerEnter:void 0,this.onTriggerExit=e&&e.onTriggerExit?e.onTriggerExit:void 0,this.onCameraEnter=e&&e.onCameraEnter?e.onCameraEnter:void 0,this.onCameraExit=e&&e.onCameraExit?e.onCameraExit:void 0,this._debugEnabled=!(!e||!e.enableDebug)&&e.enableDebug}return Object.defineProperty(t.prototype,"debugEnabled",{get:function(){return this._debugEnabled},enumerable:!1,configurable:!0}),t=o([Component("npcTriggerComponent")],t)}(),j=function(t,e){this.size=t,this.position=e},q=function(t,e){this.radius=t,this.position=e},M=function(){function t(t){this.origin=0,this.target=1,this.fraction=0,this.totalDuration=0,this.speed=[],this.loop=!1,this.path=t,Z.createAndAddToEngine()}return t.prototype.setIndex=function(t){this.fraction=0,this.origin=t,this.target=t+1<this.path.length?t+1:0},t=o([Component("npclerpData")],t)}(),K=[],Z=function(){function e(){e._instance=this}return e.prototype.update=function(e){var i,o;try{for(var s=n(K),r=s.next();!r.done;r=s.next()){var a=r.value;if(a.state==t.NPCState.FOLLOWPATH){var h=a.getComponent(Transform),u=a.getComponent(M);if(u.fraction<1)u.fraction+=e*u.speed[u.origin],h.position=Vector3.Lerp(u.path[u.origin],u.path[u.target],u.fraction);else{if(u.origin=u.target,u.target+=1,u.target>=u.path.length){if(!u.loop)return a.stopWalking(),u.onFinishCallback&&u.onFinishCallback(),void(u.fraction=1);u.target=0}else u.onReachedPointCallback&&u.onReachedPointCallback();u.fraction=0,h.lookAt(u.path[u.target])}}}}catch(t){i={error:t}}finally{try{r&&!r.done&&(o=s.return)&&o.call(s)}finally{if(i)throw i.error}}},e.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new e,engine.addSystem(this._instance)),this._instance},e._instance=null,e}(),J=100,$=function(){function t(t,e,i){this.NPCScript=[],this.isBubleOpen=!1,this.activeTextId=0,this.defaultSound=null,this.baseYOffset=2.5,this.baseYOffset=e||2.5,this.rootEntity=new Entity,this.rootEntity.addComponent(new Billboard(!1,!0,!1)),this.rootEntity.addComponent(new Transform),this.rootEntity.setParent(t),this.container=new Entity,this.container.addComponent(new Transform({position:new Vector3(-.1,this.baseYOffset,0)})),this.container.setParent(this.rootEntity),this.material=new BasicMaterial,this.material.texture=m,this.panel=new Entity,this.panel.addComponent(new Transform({scale:new Vector3(2,1,1)})),this.panel.setParent(this.container),this.panel.addComponent(new PlaneShape),this.panel.addComponent(this.material),this.panel.getComponent(PlaneShape).visible=!1,b(this.panel.getComponent(PlaneShape),x.bubbles.normal,1024,1024),this.text=new Entity,this.text.addComponent(new Transform({position:new Vector3(0,0,.05),rotation:Quaternion.Euler(0,180,0)})),this.text.addComponent(new TextShape("")),this.text.setParent(this.container),this.text.getComponent(TextShape).textWrapping=!0,this.text.getComponent(TextShape).font=p,this.text.getComponent(TextShape).hTextAlign="center",this.text.getComponent(TextShape).vTextAlign="center",this.text.getComponent(TextShape).fontSize=1,this.text.getComponent(TextShape).fontWeight="normal",this.text.getComponent(TextShape).color=Color3.Black(),this.text.getComponent(TextShape).visible=!1,this.soundEnt=new Entity,i&&(this.soundEnt.addComponent(new Transform),engine.addEntity(this.soundEnt),this.soundEnt.setParent(this.container),this.soundEnt.addComponent(new AudioSource(new AudioClip(i))),this.soundEnt.getComponent(AudioSource).volume=.5,this.defaultSound=i),tt.createAndAddToEngine()}return t.prototype.openDialogWindow=function(t,e){this.NPCScript=t,this.activeTextId=e?"number"==typeof e?e:function(t,e){for(var i=0;i<t.length;i++)if(t[i].name&&t[i].name==e)return i;return 0}(t,e):0;var i=t[this.activeTextId]?t[this.activeTextId]:{text:""};i.audio?(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(i.audio))),this.soundEnt.getComponent(AudioSource).volume=.5,this.soundEnt.getComponent(AudioSource).playOnce()):this.defaultSound&&(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(this.defaultSound))),this.soundEnt.getComponent(AudioSource).playOnce()),this.text.getComponent(TextShape).fontSize=i.fontSize?i.fontSize:1,this.text.getComponent(Transform).position.y=i.offsetY?i.offsetY+0:0,this.text.getComponent(Transform).position.x=i.offsetX?i.offsetX:0,this.text.getComponent(TextShape).visible=!0,this.panel.getComponent(PlaneShape).visible=!0,this.text.getComponent(TextShape).value="",i.text.length<J&&i.text.slice(0,J),tt._instance.newText(this,i.text,this.activeTextId,i.timeOn?i.timeOn:void 0,i.typeSpeed?i.typeSpeed:void 0),this.adjustBubble(i.text.length),this.layoutDialogWindow(this.activeTextId),this.isBubleOpen=!0},t.prototype.adjustBubble=function(t){t<8?(b(this.panel.getComponent(PlaneShape),x.bubbles.short,1024,1024),this.panel.getComponent(Transform).scale.x=.58,this.panel.getComponent(Transform).scale.y=.42,this.container.getComponent(Transform).position.x=-.1,this.container.getComponent(Transform).position.y=this.baseYOffset+-.2,this.text.getComponent(TextShape).width=.7):t<25?(b(this.panel.getComponent(PlaneShape),x.bubbles.normal,1024,1024),this.panel.getComponent(Transform).scale.x=1.43,this.panel.getComponent(Transform).scale.y=.42,this.container.getComponent(Transform).position.x=-.5,this.container.getComponent(Transform).position.y=this.baseYOffset+-.2,this.text.getComponent(TextShape).width=1.5):t<50?(b(this.panel.getComponent(PlaneShape),x.bubbles.long,1024,1024),this.panel.getComponent(Transform).scale.x=2.485,this.panel.getComponent(Transform).scale.y=.765,this.container.getComponent(Transform).position.y=this.baseYOffset+0,this.container.getComponent(Transform).position.x=-.8,this.text.getComponent(TextShape).width=2):(b(this.panel.getComponent(PlaneShape),x.bubbles.huge,1024,1024),this.panel.getComponent(Transform).scale.x=2.485,this.panel.getComponent(Transform).scale.y=1.195,this.container.getComponent(Transform).position.y=this.baseYOffset+.2,this.container.getComponent(Transform).position.x=-.8,this.text.getComponent(TextShape).width=2)},t.prototype.next=function(){var t=this.NPCScript[this.activeTextId];t||(t=this.NPCScript[this.activeTextId-1]),t.triggeredByNext&&t.triggeredByNext(),t.isEndOfDialog?this.closeDialogWindow():(this.activeTextId++,(t=this.NPCScript[this.activeTextId]).text.length<J&&t.text.slice(0,J),this.text.getComponent(TextShape).value="",this.adjustBubble(t.text.length),tt._instance.newText(this,t.text,this.activeTextId,t.timeOn?t.timeOn:void 0,t.typeSpeed?t.typeSpeed:void 0),this.layoutDialogWindow(this.activeTextId))},t.prototype.layoutDialogWindow=function(t){var e=this.NPCScript[t]?this.NPCScript[t]:{text:""},i=e.offsetY?e.offsetY+0:0;e.buttons&&e.buttons.length>=3?i+=50:e.buttons&&e.buttons.length>=1&&(i+=24),this.text.getComponent(TextShape).fontSize=e.fontSize?e.fontSize:1,this.text.getComponent(Transform).position.y=i,e.audio?(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(e.audio))),this.soundEnt.getComponent(AudioSource).volume=.5,this.soundEnt.getComponent(AudioSource).playOnce()):this.defaultSound&&(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(this.defaultSound))),this.soundEnt.getComponent(AudioSource).playOnce())},t.prototype.closeDialogWindow=function(){this.isBubleOpen&&(this.isBubleOpen=!1,this.text.getComponent(TextShape).value="",this.text.getComponent(TextShape).visible=!1,this.panel.getComponent(PlaneShape).visible=!1)},t.prototype.closeDialogEndAll=function(){this.isBubleOpen&&(this.isBubleOpen=!1,this.text.getComponent(TextShape).value="",this.text.getComponent(TextShape).visible=!1,this.panel.getComponent(PlaneShape).visible=!1,tt._instance.Dialog==this&&(tt._instance.done=!0))},t.prototype.skipDialogs=function(){if(this.isBubleOpen)for(;this.NPCScript[this.activeTextId];){if(this.NPCScript[this.activeTextId].triggeredByNext&&this.NPCScript[this.activeTextId].triggeredByNext(),this.NPCScript[this.activeTextId].isEndOfDialog)return void this.closeDialogWindow();this.activeTextId+=1}},t}(),tt=function(){function t(){this.timer=0,this.speed=45,this.visibleChars=0,this.fullText="",this.Text=null,this.textId=0,this.done=!0,this.showing=!1,this.timeOn=3,t._instance=this}return t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.update=function(t){if(!this.done)if(this.timer+=t,this.showing)this.timer>this.timeOn&&(this.showing=!1,this.done=!0,this.timer=0,this.window.next());else if(this.timer>=2/this.speed){var e=Math.floor(this.timer/(1/this.speed));this.timer=0,this.visibleChars+=e,this.closeTag(e),this.visibleChars>=this.fullText.length&&(this.showing=!0,this.timer=0,this.visibleChars=this.fullText.length),this.Text&&(this.Text.value=this.fullText.substr(0,this.visibleChars))}},t.prototype.newText=function(t,e,i,o,n){if(t!=this.Dialog||i!=this.textId){var s=this.Dialog;this.Dialog=t,this.Text=this.Dialog.text.getComponent(TextShape),this.textId=i,s&&t!=s&&s.skipDialogs(),this.timer=0,this.done=!1,this.showing=!1,this.fullText=e,this.visibleChars=0,this.window=t,n&&n<=0?this.rush():this.speed=n||45,this.timeOn=o||3}},t.prototype.rush=function(){this.showing=!0,this.timer=0,this.visibleChars=this.fullText.length,this.Text&&(this.Text.value=this.fullText)},t.prototype.closeTag=function(t){if(0!=this.visibleChars&&0!=t){for(var e=!1,i=!1,o=this.visibleChars-t;o<this.visibleChars;o++)e?">"==this.fullText.substr(o,1)&&(i=!0):"<"==this.fullText.substr(o,1)&&(e=!0);if(e&&!i)for(;this.visibleChars<this.fullText.length&&">"!=this.fullText.substr(this.visibleChars-1,1);)this.visibleChars+=1}},t._instance=null,t}();var et=function(e){function o(i,o,n,r){var a=e.call(this)||this;a.introduced=!1,a.onWalkAway=null,a.inCooldown=!1,a.coolDownDuration=5,a.faceUser=!1,a.walkingAnim=null,a.walkingSpeed=2,a.bubbleHeight=2,a.addComponent(new GLTFShape(o)),a.addComponent(new Transform(i)),engine.addEntity(a),a.state=t.NPCState.STANDING,r&&r.noUI||(r&&r.portrait?a.dialog=new R("string"==typeof r.portrait?{path:r.portrait}:r.portrait,!(!r||!r.darkUI)&&r.darkUI,r.dialogSound?r.dialogSound:void 0):a.dialog=new R(void 0,!(!r||!r.darkUI)&&r.darkUI,r&&r.dialogSound?r.dialogSound:void 0)),r&&r.textBubble&&(r&&r.bubbleHeight&&(a.bubbleHeight=r.bubbleHeight),a.bubble=new $(a,a.bubbleHeight,r.dialogSound?r.dialogSound:void 0)),a.addComponent(new Animator),a.idleAnim=new AnimationState(r&&r.idleAnim?r.idleAnim:"Idle",{looping:!0}),a.getComponent(Animator).addClip(a.idleAnim),a.lastPlayedAnim=a.idleAnim,a.idleAnim.play(),r&&r.walkingAnim&&(a.walkingAnim=new AnimationState(r.walkingAnim,{looping:!0}),a.getComponent(Animator).addClip(a.walkingAnim)),a.onActivate=n,r&&r.onWalkAway&&(a.onWalkAway=r.onWalkAway),a.endAnimTimer=new Entity,engine.addEntity(a.endAnimTimer),a.closeDialogTimer=new Entity,engine.addEntity(a.closeDialogTimer),a.pauseWalkingTimer=new Entity,engine.addEntity(a.pauseWalkingTimer);var h=r&&r.onlyClickTrigger?ActionButton.POINTER:ActionButton.PRIMARY;a.addComponent(new OnPointerDown((function(t){a.inCooldown||a.dialog&&a.dialog.isDialogOpen||a.activate()}),{button:h,hoverText:r&&r.hoverText?r.hoverText:"Talk",showFeedback:!r||!r.onlyExternalTrigger})),r&&r.onlyExternalTrigger&&a.removeComponent(OnPointerDown);var u={};return(!r||r&&!r.continueOnWalkAway)&&(u.onCameraExit=function(){a.handleWalkAway()}),r&&(!r||r.onlyExternalTrigger||r.onlyClickTrigger||r.onlyETrigger)||(u.onCameraEnter=function(){a.inCooldown?log(a.name," in cooldown"):a.dialog&&a.dialog.isDialogOpen||r&&r.onlyExternalTrigger||r&&r.onlyClickTrigger||a.activate()}),(u.onCameraEnter||u.onCameraExit)&&a.addComponent(new Q(new q(r&&r.reactDistance?r.reactDistance:6,Vector3.Zero()),u)),r&&r.faceUser&&(a.addComponent(new s(!0,r.turningSpeed?r.turningSpeed:void 0)),a.faceUser=!0),r&&r.walkingSpeed&&(a.walkingSpeed=r.walkingSpeed),r&&r.coolDownDuration&&(a.coolDownDuration=r.coolDownDuration),r&&r.path&&(a.addComponent(new M(r.path?r.path:[])),a.getComponent(M).loop=!0,K.push(a),a.followPath()),a}return i(o,e),o.prototype.activate=function(){var t=this;this.faceUser&&(this.getComponent(s).active=!0),this.inCooldown=!0,this.addComponentOrReplace(new v(this.coolDownDuration,(function(){t.inCooldown=!1}))),this.onActivate()},o.prototype.endInteraction=function(){this.faceUser&&(this.getComponent(s).active=!1),this.dialog&&this.dialog.isDialogOpen&&this.dialog.closeDialogWindow(),this.bubble&&this.bubble.isBubleOpen&&this.bubble.closeDialogWindow(),this.state=t.NPCState.STANDING},o.prototype.handleWalkAway=function(){this.state!=t.NPCState.FOLLOWPATH&&(this.endInteraction(),this.onWalkAway&&this.onWalkAway())},o.prototype.talk=function(e,i,o){var n=this;this.introduced=!0,this.state=t.NPCState.TALKING,this.closeDialogTimer.hasComponent(v)&&this.closeDialogTimer.removeComponent(v),this.bubble&&this.bubble.isBubleOpen&&this.bubble.closeDialogWindow(),this.dialog.openDialogWindow(e,i||0),o&&this.closeDialogTimer.addComponentOrReplace(new v(o,(function(){n.dialog.closeDialogWindow()})))},o.prototype.talkBubble=function(t,e){this.bubble||(this.bubble=new $(this,this.bubbleHeight)),this.bubble.openDialogWindow(t,e||0)},o.prototype.playAnimation=function(t,e,i){var o=this;this.lastPlayedAnim.stop(),this.endAnimTimer.hasComponent(v)&&this.endAnimTimer.removeComponent(v);var n=this.getComponent(Animator).getClip(t);e&&(n.looping=!1,i&&this.endAnimTimer.addComponentOrReplace(new v(i,(function(){n.stop(),o.idleAnim&&(o.idleAnim.play(),o.lastPlayedAnim=o.idleAnim)})))),n.stop(),n.play(),this.lastPlayedAnim=n},o.prototype.changeIdleAnim=function(t,e){this.idleAnim.stop(),this.idleAnim=new AnimationState(t,{looping:!0}),this.getComponent(Animator).addClip(this.idleAnim),e&&(this.lastPlayedAnim.stop(),this.idleAnim.play(),this.lastPlayedAnim=this.idleAnim)},o.prototype.followPath=function(e){if(!this.hasComponent(M)){if(!e)return;this.addComponent(new M(e.path?e.path:[])),K.push(this)}this.faceUser&&(this.getComponent(s).active=!1);var i=this.getComponent(M);if(e){if(e.path)if(e.curve){var o=Curve3.CreateCatmullRomSpline(e.path,4*e.path.length,!!e.loop).getPoints();e.loop&&o.pop(),i.path=o}else i.path=e.path;null!=e.loop&&(i.loop=e.loop),null!=e.startingPoint&&i.setIndex(e.startingPoint),e.onFinishCallback&&(i.onFinishCallback=e.onFinishCallback),e.onReachedPointCallback&&(i.onReachedPointCallback=e.onReachedPointCallback)}var n=this.getComponent(Transform).position;(0==i.fraction&&i.path[i.origin].subtract(n).lengthSquared()>.1||i.fraction>0&&n.subtract(i.path[i.origin]).normalize()==i.path[i.target].subtract(i.path[i.origin]).normalize())&&(i.path.splice(i.origin,0,this.getComponent(Transform).position),i.fraction=0),this.getComponent(Transform).lookAt(i.path[i.target]);for(var r=0,a=[],h=0;h<i.path.length-1;h++){var u;r+=u=Vector3.Distance(i.path[h],i.path[h+1]),a.push(u)}i.loop&&(r+=u=Vector3.Distance(i.path[i.path.length-1],i.path[0]),a.push(u));e&&e.totalDuration?i.totalDuration=e.totalDuration:e&&e.speed?i.totalDuration=r/e.speed:i.totalDuration||(i.totalDuration=r/this.walkingSpeed),i.speed=[];for(h=0;h<a.length;h++)i.speed.push(1/(a[h]/r*i.totalDuration));this.walkingAnim&&(this.endAnimTimer.hasComponent(v)&&this.endAnimTimer.removeComponent(v),this.idleAnim.stop(),this.lastPlayedAnim.stop(),this.walkingAnim.play(),this.lastPlayedAnim=this.walkingAnim),this.state=t.NPCState.FOLLOWPATH},o.prototype.stopWalking=function(e){var i=this;this.state=t.NPCState.STANDING,this.walkingAnim&&(this.walkingAnim.stop(),this.idleAnim.play(),this.lastPlayedAnim=this.idleAnim),e&&this.pauseWalkingTimer.addComponentOrReplace(new v(e,(function(){i.dialog&&i.dialog.isDialogOpen||(i.lastPlayedAnim.stop(),i.walkingAnim&&(i.walkingAnim.play(),i.lastPlayedAnim=i.walkingAnim),i.endAnimTimer.hasComponent(v)&&i.endAnimTimer.removeComponent(v),i.state=t.NPCState.FOLLOWPATH)})))},o}(Entity);t.CustomDialogButton=Y,t.DialogTypeInSystem=U,t.DialogWindow=R,t.NPC=et,t.NPCDelay=v,t.NPCLerpData=M,t.NPCTriggerComponent=Q,t.SFFont=g,t.SFHeavyFont=p,t.TrackUserFlag=s,t.TriggerBoxShape=j,t.TriggerSphereShape=q,t.canvas=u,t.darkTheme=f,t.lightTheme=d,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
